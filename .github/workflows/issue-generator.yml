# This workflow manually generates GitHub Issues from the DEVELOPMENT_PLAN.md file.

name: "Generate Issues from Plan"

on:
  workflow_dispatch:
    inputs:
      phase_number:
        description: 'Phase number to generate issues for (e.g., 1)'
        required: true
        type: string

jobs:
  generate-issues:
    runs-on: ubuntu-latest
    permissions:
      issues: write # This permission is required to create issues.

    steps:
      - name: "Checkout code"
        uses: actions/checkout@v3

      - name: "Parse and Create Issues"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PHASE_INPUT: ${{ github.event.inputs.phase_number }}
        run: |
          echo "üöÄ Starting issue generation for Phase $PHASE_INPUT..."

          # Read the content of the development plan
          PLAN_CONTENT=$(cat DEVELOPMENT_PLAN.md)

          # Extract the content for the specified phase
          # This uses awk to find the lines between "### „Éï„Çß„Éº„Ç∫ X" and the next "### „Éï„Çß„Éº„Ç∫" or end of file.
          PHASE_SECTION=$(awk -v phase="$PHASE_INPUT" '$0 ~ "^### „Éï„Çß„Éº„Ç∫ " phase {flag=1; next} /^### „Éï„Çß„Éº„Ç∫/ {flag=0} flag' DEVELOPMENT_PLAN.md)

          if [ -z "$PHASE_SECTION" ]; then
            echo "‚ùå Error: Could not find Phase $PHASE_INPUT in DEVELOPMENT_PLAN.md"
            exit 1
          fi

          # Extract tasks from the section and create issues
          # This looks for lines starting with "- [ ] **Task:**"
          echo "$PHASE_SECTION" | while IFS= read -r line; do
            if [[ $line == *"- [ ] "* ]]; then
              # Extract the title from the markdown task line
              title=$(echo "$line" | sed -e 's/- \[ \] \*\*Task:\*\* //' -e 's/\r//')

              # Determine the label based on task content
              if [[ $title == *"(frontend)"* ]]; then
                label_frontend=',"frontend"'
                # Clean up title
                title=$(echo "$title" | sed 's/(frontend) //')
              else
                label_frontend=''
              fi

              echo "ü§ñ Creating issue: '$title'"

              # Create the issue using GitHub CLI
              gh issue create --title "$title" --body "This issue was automatically generated from the development plan for Phase $PHASE_INPUT." --label "Phase $PHASE_INPUT,enhancement${label_frontend}"

              if [ $? -eq 0 ]; then
                echo "‚úÖ Successfully created issue."
              else
                echo "‚ùå Failed to create issue. Please check token permissions."
              fi
            fi
          done

          echo "üéâ Issue generation finished!"
