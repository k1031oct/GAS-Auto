name: Create Initial Issues

on:
  # mainブランチへのプッシュ時に実行 (初期セットアップ用)
  push:
    branches:
      - main
  # IssueまたはPull Requestへのコメント作成時に実行
  issue_comment:
    types: [created]

jobs:
  create-issues:
    # プッシュ時、またはコメントにコマンドが含まれる場合のみジョブを実行
    if: github.event_name == 'push' || (github.event_name == 'issue_comment' && contains(github.event.comment.body, '/create-initial-issues'))
    runs-on: ubuntu-latest
    # Issueを作成・編集するための権限を付与
    permissions:
      issues: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Create issues from MANUAL_SETUP.md
        uses: actions/github-script@v6
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"
          script: |
            const fs = require('fs');
            const manual = fs.readFileSync('MANUAL_SETUP.md', 'utf8');
            const lines = manual.split('\n');

            // Helper function to create an issue
            async function createIssue(title, bodyLines, section, { github, context }) {
              if (!title) {
                return;
              }

              let body = `This task is part of the **${section}** setup.\n\n`;
              if (bodyLines.length > 0) {
                body += `### Description\n\n${bodyLines.join('\n')}\n\n`;
              }
              body += `*Please refer to the [MANUAL_SETUP.md](MANUAL_SETUP.md) file for the full context.*`;

              const { data: issues } = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                labels: 'initial-setup'
              });

              const issueExists = issues.some(issue => issue.title === title);

              if (!issueExists) {
                console.log(`Creating issue: ${title}`);
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: title,
                  body: body,
                  labels: ['initial-setup']
                });
              } else {
                console.log(`Skipping existing issue: ${title}`);
              }
            }

            let currentSection = '';
            let currentTitle = null;
            let currentBodyLines = [];

            for (const line of lines) {
              if (line.startsWith('## ')) { // New section
                await createIssue(currentTitle, currentBodyLines, currentSection, { github, context });
                currentSection = line.substring(3).trim();
                currentTitle = null;
                currentBodyLines = [];
              } else if (line.startsWith('- [ ] ')) { // New task
                await createIssue(currentTitle, currentBodyLines, currentSection, { github, context });
                currentTitle = line.substring(6).trim();
                currentBodyLines = [];
              } else if (currentTitle && line.trim() !== '' && line.startsWith('  -')) { // Description line
                currentBodyLines.push(line.substring(2));
              }
            }

            // Create the very last issue in the file
            await createIssue(currentTitle, currentBodyLines, currentSection, { github, context });
