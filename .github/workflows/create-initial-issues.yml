name: Create Initial Issues

on:
  # mainブランチへのプッシュ時に実行 (初期セットアップ用)
  push:
    branches:
      - main
  # IssueまたはPull Requestへのコメント作成時に実行
  issue_comment:
    types: [created]

jobs:
  create-issues:
    # プッシュ時、またはコメントにコマンドが含まれる場合のみジョブを実行
    if: github.event_name == 'push' || (github.event_name == 'issue_comment' && contains(github.event.comment.body, '/create-initial-issues'))
    runs-on: ubuntu-latest
    # Issueを作成・編集するための権限を付与
    permissions:
      issues: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Create issues from MANUAL_SETUP.md
        uses: actions/github-script@v6
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"
          script: |
            const fs = require('fs');
            const manual = fs.readFileSync('MANUAL_SETUP.md', 'utf8');
            const lines = manual.split('\n');

            let currentSection = '';
            for (const line of lines) {
              if (line.startsWith('## ')) {
                currentSection = line.substring(3);
              } else if (line.startsWith('- [ ] ')) {
                const title = line.substring(6);
                const body = `This task is part of the **${currentSection}** setup.\n\nPlease refer to the [MANUAL_SETUP.md](MANUAL_SETUP.md) file for more details.`;

                // Check if an issue with the same title already exists
                const { data: issues } = await github.rest.issues.listForRepo({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  state: 'open',
                  labels: 'initial-setup'
                });

                const issueExists = issues.some(issue => issue.title === title);

                if (!issueExists) {
                  await github.rest.issues.create({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    title: title,
                    body: body,
                    labels: ['initial-setup']
                  });
                }
              }
            }
